# ğŸ“¦ Kubernetes StatefulSet ile PostgreSQL Kurulumu ve CronJob ile Yedekleme

Kubernetes'te durum bilgisi taÅŸÄ±yan uygulamalar iÃ§in Statefulset kullanÄ±lÄ±r. Bu blog yazÄ±sÄ±nda bir kubernetes ortamÄ±nda Postgresql nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± ve verilerin nasÄ±l kalÄ±cÄ± hale getirileceÄŸi konusunda bilgi verilecektir. Postgresql veritabanÄ± Ã¼zerinde nasÄ±l backup alÄ±nacaÄŸÄ± ve bir backup iÅŸlemini nasÄ±l otomatize hale getirileceÄŸinden bahsedilmiÅŸtir.

Ä°lk Ã¶ncelikle yapÄ±lacak olan iÅŸlemleri daha iyi anlaÅŸÄ±lmasÄ± amacÄ±yla bilinmesi kavramlar aÅŸaÄŸÄ±daki gibidir;

* **StatefulSet**: sabit kimliÄŸe (isim/IP) sahip, sÄ±ralÄ± ÅŸekilde oluÅŸan pod'lar ile durum bilgisi taÅŸÄ±yan uygulamalarÄ± yÃ¶netmek iÃ§in kullanÄ±lÄ±r. Her pod kendi PVCâ€™sine baÄŸlanÄ±r ve bu sayede pod silinse bile veriler korunur.

* **PersistentVolume (PV)**: Cluster yÃ¶neticisi tarafÄ±ndan tanÄ±mlanan fiziksel ya da sanal disk alanÄ±dÄ±r. Dinamik veya statik olarak oluÅŸturulabilir

* **PersistentVolumeClaim (PVC)**: Pod'larÄ±n ihtiyaÃ§ duyduÄŸu disk alanÄ±nÄ± talep etmek iÃ§in kullanÄ±lÄ±r. PVCâ€™ler, uygun bir PV ile eÅŸleÅŸtirilerek kullanÄ±ma hazÄ±r hale gelir.


Ä°lk Ã¶ncelikle Postgresql yapÄ±sÄ±nÄ±n kurulmasÄ± amacÄ±yla aÅŸlaÄŸÄ±daki dosyalar oluÅŸturulur;
**01-pvc.yaml**
```yaml
# 01-pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: standard

```
**03-service.yaml**
```yaml
# 03-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: postgres
spec:
  clusterIP: None
  selector:
    app: postgres
  ports:
    - port: 5432
      targetPort: 5432

```
**02-postgres-statefulset.yaml**
```yaml
# 02-postgres-statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
spec:
  selector:
    matchLabels:
      app: postgres
  serviceName: "postgres"
  replicas: 1
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
        - name: postgres
          image: postgres:15
          ports:
            - containerPort: 5432
              name: postgres
          env:
            - name: POSTGRES_DB
              value: "testdb"
            - name: POSTGRES_USER
              value: "admin"
            - name: POSTGRES_PASSWORD
              value: "admin123"
          volumeMounts:
            - name: postgres-storage
              mountPath: /var/lib/postgresql/data
  volumeClaimTemplates:
    - metadata:
        name: postgres-storage
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: "standard"
        resources:
          requests:
            storage: 1Gi

```

OluÅŸturma iÅŸleminin ardÄ±ndan iÅŸlemin tamamlanmasÄ± amacÄ±yla aÅŸaÄŸÄ±daki komutlarÄ± kullanabilirsiniz;

```bash
kubectl apply -f 01-pvc.yaml
kubectl apply -f 03-service.yaml
kubectl apply -f 02-postgres-statefulset.yaml
```

![Postgresql](./img/Kubernetes_22.png)

Bu iÅŸlemin ardÄ±ndan ÅŸunu gerÃ§ekleÅŸtirebiliriz Ã¶rnek olmasÄ± amacÄ±yla Postgresql iÃ§erisine veri yazacaÄŸÄ±z ve pod 'u silerek verilerin kalÄ±p kalmadÄ±ÄŸÄ±nÄ± gÃ¶rÃ¼ntÃ¼leyebiliriz. Bu iÅŸlem iÃ§in;

PostgreSQL podâ€™una baÄŸlan:
```bash
kubectl exec -it postgres-0 -- psql -U admin -d testdb
```
BaÄŸlantÄ± iÅŸleminin ardÄ±ndan Ã¶rnek bir tablo oluÅŸturulur;

```sql
CREATE TABLE deneme (id SERIAL PRIMARY KEY, ad VARCHAR(50));
INSERT INTO deneme (ad) VALUES ('Murat');
SELECT * FROM deneme;
```
Bu iÅŸlemlerin ardÄ±ndan pod silinir;
```bash
kubectl delete pod postgres-0
```
![Postgresql](./img/Kubernetes_23.png)

Bu iÅŸlemler gerÃ§ekleÅŸtirildikten sonra pod'a tekrar baÄŸlanÄ±lÄ±r ve veri kontrol edilir. 

```bash
kubectl exec -it postgres-0 -- psql -U admin -d testdb
SELECT * FROM deneme;
```

![Postgresql](./img/Kubernetes_24.png)

Ä°ÅŸlemlerde gÃ¶rÃ¼ldÃ¼ÄŸÃ¼ gibi **PersistentVolume** yapÄ±sÄ± kullanÄ±larak pod silinse dahi verinin korulmasÄ± mÃ¼mkÃ¼n olur. 

### CronJob ile Otomatik Backup Alma

**Crontab**, Linux/Unix sistemlerinde zamanlanmÄ±ÅŸ gÃ¶revleri (script, komut vb.) belirli zaman aralÄ±klarÄ±nda otomatik olarak Ã§alÄ±ÅŸtÄ±rmak iÃ§in kullanÄ±lan bir zamanlayÄ±cÄ± sistemidir. Bu sistemin yedek alma amacÄ±yla Kubernetes kullanÄ±mak iÃ§in aÅŸaÄŸÄ±daki dosyalar oluÅŸturulur;

**backup-pvc.yaml**
```yaml
# backup-pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: backup-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: standard

```

**backup-cronjob.yaml**

```yaml
# backup-cronjob.yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-backup
spec:
  #schedule: "0 */12 * * *"  # Her 12 saatte bir Ã§alÄ±ÅŸÄ±r
  schedule: "*/2 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: pg-backup
            image: postgres:15
            env:
              - name: PGPASSWORD
                value: "admin123"
            command:
              - /bin/sh
              - -c
              - |
                pg_dump -h postgres-0.postgres -U admin testdb > /backup/backup-$(date +%Y-%m-%d-%H%M).sql
            volumeMounts:
              - name: backup-volume
                mountPath: /backup
          restartPolicy: OnFailure
          volumes:
            - name: backup-volume
              persistentVolumeClaim:
                claimName: backup-pvc
```

OluÅŸturma iÅŸlemi iÃ§in aÅŸaÄŸÄ±daki komutlar kullanÄ±lÄ±r;

```bash
kubectl apply -f backup-pvc.yaml
kubectl apply -f backup-cronjob.yaml
```

![Crontab](./img/Kubernetes_25.png)

Crontab iÃ§in ``schedule`` parametresinde bulunan kÄ±sÄ±m iÃ§in [crontab guru](https://crontab.guru/) sayfasÄ± kullanÄ±labilir.
Backup dosyalarÄ±n kontrol edilmesi amacÄ±yla ``inspect-backup.yaml`` dosyasÄ± oluÅŸturulur. 
**inspect-backup.yaml**
```bash
# inspect-backup.yaml
apiVersion: v1
kind: Pod
metadata:
  name: backup-inspect
spec:
  containers:
    - name: inspector
      image: busybox
      command: ["/bin/sh", "-c", "sleep 3600"]
      volumeMounts:
        - name: backup-volume
          mountPath: /backup
  volumes:
    - name: backup-volume
      persistentVolumeClaim:
        claimName: backup-pvc
  restartPolicy: Never

```
OluÅŸturulmasÄ± amacÄ±yla ``kubectl apply -f inspect-backup.yaml`` komutu kullanÄ±lÄ±r.  OluÅŸturma iÅŸleminin ardÄ±ndan aÅŸaÄŸÄ±daki komutlar kullanÄ±larak backup dosyalarÄ± kontrol edilir;


Backup iÅŸleminin kontrol edilmesi amacÄ±yla aÅŸaÄŸÄ±daki komutlar sÄ±rasÄ±yla kullanÄ±lÄ±r;
```bash
kubectl get cronjob
kubectl get pods
kubectl exec -it backup-inspect -- ls /backup
```
![Crontab](./img/Kubernetes_26.png)
