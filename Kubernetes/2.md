# ğŸ” OPA Gatekeeper ile Pod GÃ¼venlik PolitikasÄ±

**OPA Gatekeeper**, Kubernetes kÃ¼melerinde politikalarÄ± tanÄ±mlamak ve uygulamak iÃ§in kullanÄ±lan bir gÃ¼venlik aracÄ±dÄ±r. Bu tool'un ne iÅŸe yaradÄ±ÄŸÄ± soruna aÅŸaÄŸÄ±daki cevaplar verilebilir.

* Kubernetes nesnelerinin (Pod, Namespace, Ingress vb.) belirli kurallara gÃ¶re oluÅŸturulmasÄ±nÄ± **zorunlu kÄ±lar**.
* HatalÄ± ya da gÃ¼venliksiz yapÄ±landÄ±rmalarÄ±n kÃ¼meye eklenmesini **engeller**.
* TÃ¼m politikalar **deklaratif olarak YAML** ile tanÄ±mlanabilir.
* Hem **enforcement** (uygulama) hem de **audit** (izleme) modlarÄ±nda Ã§alÄ±ÅŸabilir.

Ã¶rnek olarak bu aracÄ±n nasÄ±l kullanÄ±abileceÄŸin aÅŸaÄŸÄ±daki Ã¶rnek Ã¼zerinden anlatabilirim. Ä°lk Ã¶ncelikle uygulamamÄ±zÄ±n amacÄ± sadece ``allowed-ns`` namespaceâ€™inde pod Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±na izin veren diÄŸer namespace'leri ise engelleyen bir yapÄ± kurmak istiyoruz. Bu hedefin adÄ±mlarÄ± aÅŸaÄŸÄ±daki gibidir;

Ä°lk Ã¶ncelikle bize bir kubernetes ortamÄ± gerekmektedir. Bu nedenle minikube kullanacaÄŸÄ±m. Ã¶rnek olarak ``minikube start --memory=4096 --cpus=2`` komutu kullanÄ±labilir. 
![Minikube Ortam](./img/Kubernetes_9.png)

Bu iÅŸlemin aradÄ±ndan ``OPA Gatekeeper`` kurlum iÅŸlemi iÃ§in aÅŸaÄŸÄ±daki komut kullanÄ±lmaktadÄ±r;

```bash
kubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper/release-3.14/deploy/gatekeeper.yaml
```
Kurulumun kontrol edimesi amacÄ±yla ``kubectl get pods -n gatekeeper-system`` komutu kullabilir.
![OPA Install](./img/Kubernetes_10.png)

Åimdi pod oluÅŸturabileceÄŸimiz, Ã§alÄ±ÅŸtÄ±rabileceÄŸimiz ``allowed-ns`` adlÄ± namespace'in oluÅŸturulabilmesi amacÄ±yla aÅŸaÄŸÄ±daki komut kulanÄ±labilir. 
```bash
kubectl create namespace allowed-ns
```
![Namespace Create](./img/Kubernetes_11.png)

PolitikanÄ±n oluÅŸturulabilemesi amacÄ±yla ``template-allowed-namespace.yaml`` ve ``constraint-allowed-namespace.yaml`` dosyalarÄ± oluÅŸturulur. 

**template-allowed-namespace.yaml**
```yaml
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: k8sallowednamespace
spec:
  crd:
    spec:
      names:
        kind: K8sAllowedNamespace
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8sallowednamespace

        violation[{"msg": msg}] {
          input.review.kind.kind == "Pod"
          not input.review.object.metadata.namespace == "allowed-ns"
          msg := sprintf("Pod sadece 'allowed-ns' namespace'inde Ã§alÄ±ÅŸabilir. BulunduÄŸu: %v", [input.review.object.metadata.namespace])
        }

```
**constraint-allowed-namespace.yaml**
```yaml
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sAllowedNamespace
metadata:
  name: only-allowed-ns
spec:
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
```


Bu yaml dosyalarÄ± ile sadece ``allowed-ns`` namespace'inde Pod oluÅŸturulmasÄ±na **izin vermek**. DiÄŸer namespace'lerde Pod oluÅŸturulursa Gatekeeper bu isteÄŸi **reddeder**. ``kubectl apply -f template-allowed-namespace.yaml`` ve ``kubectl apply -f constraint-allowed-namespace.yaml`` komutlarÄ± ile iÅŸlem gerÃ§ekleÅŸtirilir.

Bu iÅŸlemlerin ardÄ±ndan yapÄ±lan iÅŸlemlerin kontrol edilebilemesi amacÄ±yla ilk Ã¶ncelikle ``allowed-ns`` namespace 'inde bir pod oluÅŸturulmasÄ± amacÄ±yla aÅŸaÄŸÄ±daki ``good-pod.yaml`` dosyasÄ± kullanÄ±labilir.

**good-pod.yaml**
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: good-pod
  namespace: allowed-ns
spec:
  containers:
    - name: nginx
      image: nginx
```
``good-pod.yaml`` dosyasÄ±nÄ±n kullanÄ±lmasÄ± amacÄ±yla  ``kubectl apply -f good-pod.yaml`` komutu kullanÄ±lÄ±r. Default namespace bir pod oluÅŸturulmasÄ± amacÄ±yla ``bad-pod.yaml`` dosyasÄ± kullanÄ±lÄ±r. 

**bad-pod.yaml**
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: bad-pod
  namespace: default
spec:
  containers:
    - name: nginx
      image: nginx

```
``bad-pod.yaml`` dosyasÄ±nÄ±n kullanÄ±lmasÄ± amacÄ±yla  ``kubectl apply -f bad-pod.yaml`` komutu kullanÄ±lÄ±r.

![Test](./img/Kubernetes_12.png)

GÃ¶rselde gÃ¶rÃ¼ldÃ¼ÄŸÃ¼ gibi ``Error from server ([only-allowed-ns] Pod sadece 'allowed-ns' namespace'inde Ã§alÄ±ÅŸabilir. BulunduÄŸu: default): error when creating "bad-pod.yaml"`` hatasÄ± alÄ±nmaktadÄ±r. Bu hata polikamÄ±za uygun olarak sistemin Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± gÃ¶stermektedir.
