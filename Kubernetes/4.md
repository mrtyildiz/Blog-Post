# ğŸ” Kubernetes RBAC (Role-Based Access Control)

**RBAC,** Kubernetes Ã¼zerinde kullanÄ±cÄ±larÄ±n veya servislerin hangi kaynaklara eriÅŸebileceÄŸini **kÄ±sÄ±tlamak veya izin vermek** amacÄ±yla kullanÄ±lan yetkilendirme (authorization) sistemidir. Kubernetes 1.6 sÃ¼rÃ¼mÃ¼ndne beri yerleÅŸik olarak sunulmaktadÄ±r.

RBAC, kim neyi, nerede, ne kadar yapabilir sorusuna yanÄ±t verir.

## ğŸ“¦ RBACâ€™Ä±n Temel KavramlarÄ±

| Kavram                 | AÃ§Ä±klama                                                                                        |
| ---------------------- | ----------------------------------------------------------------------------------------------- |
| **Role**               | Belirli bir **namespace iÃ§indeki** kaynaklara (pod, configmap vs.) eriÅŸim kurallarÄ±nÄ± tanÄ±mlar. |
| **ClusterRole**        | TÃ¼m cluster genelindeki kaynaklara eriÅŸimi tanÄ±mlar. Ã–rnek: node, namespace eriÅŸimi.            |
| **RoleBinding**        | Bir **Role**â€™Ã¼ bir kullanÄ±cÄ±ya, gruba veya servis hesabÄ±na **belirli bir namespace**â€™te baÄŸlar. |
| **ClusterRoleBinding** | Bir **ClusterRole**â€™Ã¼ bir kullanÄ±cÄ±ya, gruba veya servis hesabÄ±na **cluster genelinde** baÄŸlar. |
| **ServiceAccount**     | Pod'larÄ±n kimliÄŸi gibi davranÄ±r. Pod'lar bu hesaplarla API sunucusuna kimliklerini gÃ¶sterir.    |
| **Verbs (Fiiller)**    | `get`, `list`, `create`, `delete`, `watch` gibi eylemleri tanÄ±mlar.                             |
| **Resources**          | Pod, Deployment, Service, ConfigMap, Secret gibi Kubernetes nesneleridir.                       |


## ğŸ§­ RBAC KullanÄ±m AlanlarÄ±

| ğŸ’¡ KullanÄ±m AlanÄ±                       | ğŸ“Œ AÃ§Ä±klama                                                                                                 |
| --------------------------------------- | ----------------------------------------------------------------------------------------------------------- |
| **Namespace bazlÄ± eriÅŸim kontrolÃ¼**     | GeliÅŸtiricilere yalnÄ±zca kendi namespaceâ€™lerinde kaynaklarÄ± (Ã¶rn. pod) gÃ¶rme yetkisi verilir.               |
| **YalnÄ±zca okuma eriÅŸimi verme**        | `get`, `list`, `watch` gibi sadece gÃ¶rÃ¼ntÃ¼leme yetkileriyle gÃ¶zlemci (auditor) rolleri tanÄ±mlanÄ±r.          |
| **Servis hesaplarÄ±na sÄ±nÄ±rlÄ± yetki**    | Uygulama veya otomasyon servislerine yalnÄ±zca gerekli API eylemlerini yapacak kadar izin verilir.           |
| **Cluster yÃ¶netici yetkilerinin devri** | KullanÄ±cÄ±lara sadece belirli cluster kaynaklarÄ±na (Ã¶rn. `nodes`, `persistentvolumes`) eriÅŸim izni verilir.  |
| **CI/CD araÃ§larÄ±na Ã¶zel yetkiler**      | Jenkins, ArgoCD gibi araÃ§lara sadece deploy, gÃ¼ncelleme gibi gÃ¶revleri yerine getirecek izinler tanÄ±mlanÄ±r. |


Bu kavramÄ±n daha iyi anlaÅŸÄ±lmasÄ± amacÄ±yla Ã¶rnek iki alÄ±ÅŸtÄ±rma yapabiliriz.[KillerCoda](https://killercoda.com/killer-shell-cka) adresinde bulunan Ã¶rnek RBAC senaryolarÄ±nÄ± Ã§Ã¶zÃ¼lebilir. Ä°lk senaryoya [Buradan](https://killercoda.com/killer-shell-cka/scenario/rbac-serviceaccount-permissions) ulaÅŸabilirsiniz. Senaryo Ã§Ã¶zÃ¼mÃ¼ aÅŸaÄŸÄ±daki gibidir;

Ä°lk Ã¶ncelikle mevcut namespaces kontrol ederek baÅŸlÄ±yorum. SonrasÄ±nda soruda bahsi geÃ§en ``ns1`` ve ``ns2`` iÃ§in ``pipeline`` adÄ±nda ServiceAccount oluÅŸturulmasÄ± iÃ§in;

```bash
kubectl create serviceaccount pipeline -n ns1
kubectl create serviceaccount pipeline -n ns2
```
Bu ServiceAccount daha sonra RBAC ile yetkilendirilerek API serverâ€™a eriÅŸim saÄŸlayacak.

![pipeline](./img/Kubernetes_16.png)


Ä°kinci adÄ±mda her ServiceAccount'a tÃ¼m cluster genelinde gÃ¶rÃ¼ntÃ¼leme yetkisi veriyoruz. AÅŸaÄŸÄ±daki ``view-ns1-pipeline.yaml`` ve ``view-ns2-pipeline.yaml`` dosyalarÄ± kullanÄ±larak gerekli kural oluÅŸturulabilir;

**view-ns1-pipeline.yaml**

```yaml
# view-ns1-pipeline.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: pipeline-view-ns1
subjects:
- kind: ServiceAccount
  name: pipeline
  namespace: ns1
roleRef:
  kind: ClusterRole
  name: view
  apiGroup: rbac.authorization.k8s.io

```

**view-ns2-pipeline.yaml**

```yaml
# view-ns2-pipeline.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: pipeline-view-ns2
subjects:
- kind: ServiceAccount
  name: pipeline
  namespace: ns2
roleRef:
  kind: ClusterRole
  name: view
  apiGroup: rbac.authorization.k8s.io

```

Bu iÅŸlem iÃ§in kullanÄ±lacak komutlar aÅŸaÄŸÄ±daki gibidir;
```bash
kubectl apply -f view-ns1-pipeline.yaml
kubectl apply -f view-ns2-pipeline.yaml
```
![pipeline](./img/Kubernetes_17.png)

Ã¼Ã§Ã¼nÃ§Ã¼ adÄ±mda, sadece kendi namespaceâ€™inde ``Deployment`` oluÅŸturma ve silme izni tanÄ±mlÄ±yoruz. Bu ``Role`` sadece kendi namespace iÃ§inde geÃ§erlidir. Daha geniÅŸ bir kapsam istenseydi ``ClusterRole`` kullanÄ±lÄ±r.

Bu iÅŸlem iÃ§in;
**role-deploy-ns1.yaml**
```yaml
# role-deploy-ns1.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: ns1
  name: deploy-manager
rules:
- apiGroups: ["apps"]
  resources: ["deployments"]
  verbs: ["create", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: bind-deploy-manager
  namespace: ns1
subjects:
- kind: ServiceAccount
  name: pipeline
  namespace: ns1
roleRef:
  kind: Role
  name: deploy-manager
  apiGroup: rbac.authorization.k8s.io

```

**role-deploy-ns2.yaml**
```yaml
# role-deploy-ns2.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: ns2
  name: deploy-manager
rules:
- apiGroups: ["apps"]
  resources: ["deployments"]
  verbs: ["create", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: bind-deploy-manager
  namespace: ns2
subjects:
- kind: ServiceAccount
  name: pipeline
  namespace: ns2
roleRef:
  kind: Role
  name: deploy-manager
  apiGroup: rbac.authorization.k8s.io

```

OluÅŸturma iÅŸlemi iÃ§in;

```bash
kubectl apply -f role-deploy-ns1.yaml
kubectl apply -f role-deploy-ns2.yaml
```

![role](./img/Kubernetes_18.png)

YapÄ±lan bu iÅŸlemleri kontrol edilmesi amacÄ±yla;
```bash
# ns1 iÃ§indeki pipeline SA'nÄ±n tÃ¼m podlarÄ± gÃ¶rÃ¼ntÃ¼leyip gÃ¶rÃ¼ntÃ¼leyemediÄŸini kontrol et
kubectl auth can-i get pods --as=system:serviceaccount:ns1:pipeline -n kube-system

# ns1 iÃ§indeki pipeline SA'nÄ±n ns1 iÃ§inde Deployment oluÅŸturup oluÅŸturamayacaÄŸÄ±nÄ± kontrol et
kubectl auth can-i create deployments --as=system:serviceaccount:ns1:pipeline -n ns1

# ns1 SA'nÄ±n ns2 iÃ§indeki Deployment silme yetkisi olmadÄ±ÄŸÄ±nÄ± kontrol et (beklenen sonuÃ§: no)
kubectl auth can-i delete deployments --as=system:serviceaccount:ns1:pipeline -n ns2

```
![auth can](./img/Kubernetes_19.png)

Birinci senaryonun Ã§Ã¶zÃ¼mÃ¼ bu ÅŸekilde ikinci senaryoya [Buradan](https://killercoda.com/killer-shell-cka/scenario/rbac-user-permissions) ulaÅŸabilirsiniz. Bu senaryonun Ã§Ã¶zÃ¼lmesi amacÄ±yla uygulanmasÄ± gereken adÄ±mlar aÅŸaÄŸÄ±daki gibidir;

Ä°lk olarak ``smoke`` adlÄ± kullanÄ±cÄ±ya sadece bu namespace iÃ§inde Pod, Deployment ve StatefulSet kaynaklarÄ±nÄ±n Create ve delete yetkisi veilmesi iÃ§in;

**applications-pod-control.yaml**
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: pod-controller
  namespace: applications
rules:
- apiGroups: ["", "apps"]
  resources: ["pods", "deployments", "statefulsets"]
  verbs: ["create", "delete"]

```

RoleBinding ile ``smoke`` kullanÄ±cÄ±sÄ±na bu rolÃ¼ baÄŸlamak iÃ§in:
**applications-rolebinding.yaml**
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: pod-controller-binding
  namespace: applications
subjects:
- kind: User
  name: smoke
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: Role
  name: pod-controller
  apiGroup: rbac.authorization.k8s.io
```

Bu iÅŸlemin gerÃ§ekleÅŸtirilmesi amaÃ§Ä±yla;

```bash
kubectl apply -f applications-pod-control.yaml
kubectl apply -f applications-rolebinding.yaml
```
![auth can](./img/Kubernetes_20.png)

ikinci adÄ±mda ``smoke`` adlÄ± kullanÄ±cÄ±nÄ±n tÃ¼m namespace view yetkisinin verilmesi(kube-system hariÃ§) iÃ§in;

**cluster-view-except-kube-system.yaml**
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: smoke-cluster-view
subjects:
- kind: User
  name: smoke
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: view
  apiGroup: rbac.authorization.k8s.io

```

Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ± amacÄ±yla ``kubectl apply -f cluster-view-except-kube-system.yaml`` komutu kullanÄ±lÄ±r. ÃœÃ§Ã¼ncÃ¼ adÄ±m olarak yetkilerin kontrol edilmesi amacÄ±yla aÅŸaÄŸÄ±daki komutlar kullanÄ±lÄ±r;

```bash
# applications
k auth can-i create deployments --as smoke -n applications # YES
k auth can-i delete deployments --as smoke -n applications # YES
k auth can-i delete pods --as smoke -n applications # YES
k auth can-i delete sts --as smoke -n applications # YES
k auth can-i delete secrets --as smoke -n applications # NO
k auth can-i list deployments --as smoke -n applications # YES
k auth can-i list secrets --as smoke -n applications # NO
k auth can-i get secrets --as smoke -n applications # NO

# view in all namespaces but not kube-system
k auth can-i list pods --as smoke -n default # YES
k auth can-i list pods --as smoke -n applications # YES
k auth can-i list pods --as smoke -n kube-public # YES
k auth can-i list pods --as smoke -n kube-node-lease # YES
k auth can-i list pods --as smoke -n kube-system # NO
```

![auth can](./img/Kubernetes_21.png)
