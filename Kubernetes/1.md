# ğŸš€ Kubernetes ile Blue-Green Deployment ve Ingress Trafik YÃ¶nlendirme

Blue-Green Deployment, uygulamanÄ±n farklÄ± versiyonlarÄ±nÄ±n aynÄ± anda Ã§alÄ±ÅŸmasÄ±na izin vererek sÄ±fÄ±r kesintiyle yeni sÃ¼rÃ¼me geÃ§iÅŸ yapÄ±lmasÄ±na imkan saÄŸlamaktadÄ±r. Bu strateji sayesinde, eski version(blue) Ã§alÄ±ÅŸÄ±rken yyeni versiyon (green) hazÄ±r hale getirilebilir ve sadece trafiÄŸin yÃ¶n deÄŸiÅŸtirerek geÃ§iÅŸ yapÄ±labilir. Roolback ise yine sadece trafik yÃ¶nÃ¼nÃ¼ eski sÃ¼rÃ¼me Ã§evirerek Ã§ok hÄ±zlÄ± bir ÅŸekilde gerÃ§ekleÅŸtirilebilir. Bu yazÄ±da bu iÅŸlemi uygulamalÄ± bir ÅŸekilde gÃ¶relim. Ä°lk Ã¶ncelik ortam olarak killercoda bulunan **Kubernetes 1.32** ortamÄ± kullanÄ±lmaktadÄ±r.

Ä°lk olarak tÃ¼m kaynaklarÄ±mÄ±zÄ±n izole bir ortamda yÃ¶netmek iÃ§in Ã¶zel bir namespace oluÅŸturmak iÃ§in aÅŸaÄŸÄ±daki komut kullanÄ±lÄ±r;

```
kubectl create namespace blue-green-demo
```
![Namespace](/img/Kubernetes_1.png)

Blue ve Green Deploymentâ€™larÄ±nÄ±n oluÅŸturulmasÄ± amacÄ±yla aÅŸaÄŸÄ±daki ``blue-deployment.yaml`` ve ``green-deployment.yaml`` dosyalarÄ± oluÅŸturulur.
**blue-deployment.yaml**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: app-blue
  namespace: blue-green-demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: myapp
      version: blue
  template:
    metadata:
      labels:
        app: myapp
        version: blue
    spec:
      containers:
        - name: nginx
          image: nginx:1.21
          ports:
            - containerPort: 80

```
**green-deployment.yaml**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: app-green
  namespace: blue-green-demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: myapp
      version: green
  template:
    metadata:
      labels:
        app: myapp
        version: green
    spec:
      containers:
        - name: nginx
          image: nginx:1.25
          ports:
            - containerPort: 80

```
OluÅŸturma iÅŸlemi iÃ§in aÅŸaÄŸÄ±daki komutlar sÄ±rasÄ±yla kullanÄ±lÄ±r;

```bash
kubectl apply -f blue-deployment.yaml
kubectl apply -f green-deployment.yaml
```
![blue-green](/img/Kubernetes_2.png)

Blue ve Green olarak iki farklÄ± versiyonlu Deployment tanÄ±mlÄ±yoruz. Her biri farklÄ± label (version: blue / green) ile ayÄ±rt ediyoruz.

Servislerin tanÄ±mlanmasÄ± amacÄ±yla ``blue-service.yaml`` ve ``green-service.yaml`` dosyalarÄ± oluÅŸturulur. 

**blue-service.yaml**
```yaml
apiVersion: v1
kind: Service
metadata:
  name: myapp-blue
  namespace: blue-green-demo
spec:
  selector:
    app: myapp
    version: blue
  ports:
    - port: 80
      targetPort: 80

```
**green-service.yaml**
```yaml
apiVersion: v1
kind: Service
metadata:
  name: myapp-green
  namespace: blue-green-demo
spec:
  selector:
    app: myapp
    version: green
  ports:
    - port: 80
      targetPort: 80

```
Servislerin oluÅŸturulmasÄ± amacÄ±yla aÅŸaÄŸÄ±daki komutlar sÄ±rasÄ±yla kullanÄ±lÄ±r. 

```bash
kubectl apply -f blue-service.yaml
kubectl apply -f green-service.yaml
```
![blue-green service](/img/Kubernetes_3.png)

Her bir versiyon iÃ§in ayrÄ± bir servis oluÅŸturuyoruz. Bu servisler ilgili Deploymentâ€™lara trafiÄŸi yÃ¶nlendiriyor ancak kullanÄ±cÄ± trafiÄŸini bu servisler Ã¼zerinden doÄŸrudan almÄ±yoruz.

CanlÄ± trafiÄŸin doÄŸrundan yÃ¶netilmesi amacÄ±yla ``Live`` servisin oluÅŸturulmasÄ± amacÄ±yla ``live-service.yaml`` dosyasÄ± oluÅŸturulur.

**live-service.yaml**
```yaml
apiVersion: v1
kind: Service
metadata:
  name: myapp-live
  namespace: blue-green-demo
spec:
  selector:
    app: myapp
    version: blue  # BaÅŸlangÄ±Ã§ta blue'a yÃ¶nlendiriliyor
  ports:
    - port: 80
      targetPort: 80

```
Bu servisin oluÅŸturulmasÄ± amacÄ±yla ``kubectl apply -f live-service.yaml`` komutu kullanÄ±lmaktadÄ±r. 

![blue-green service](/img/Kubernetes_4.png)

Bu servis, kullanÄ±cÄ±dan gelen tÃ¼m trafiÄŸi â€œcanlÄ± versiyonaâ€ yÃ¶nlendiren yapÄ±dÄ±r. Ä°lk olarak blue versiyona yÃ¶nlendirilmiÅŸtir. Daha sonra selector alanÄ±nÄ± deÄŸiÅŸtirerek green versiyona geÃ§iÅŸ yapÄ±labilir.

DÄ±ÅŸ network(DÃ¼nya) eriÅŸiminin saÄŸlanmasÄ± amacÄ±yla ``ingress.yaml`` dosyasÄ± oluÅŸturulur.
**ingress.yaml**
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: myapp-ingress
  namespace: blue-green-demo
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  rules:
    - host: myapp.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: myapp-live
                port:
                  number: 80
```
Bu Ingress nesnesi, myapp.local adresinden gelen HTTP isteklerini myapp-live servisine yÃ¶nlendirir. BÃ¶ylece kullanÄ±cÄ± dÄ±ÅŸarÄ±dan sadece tek bir endpointâ€™i (myapp.local) gÃ¶rÃ¼r. Bu servisin oluÅŸturulmasÄ± amacÄ±yla ``kubectl apply -f ingress.yaml`` komutu kullanÄ±lmaktadÄ±r.
![blue-green ingress](/img/Kubernetes_5.png)


ğŸ“Œ Not: myapp.local adresini tarayÄ±cÄ±nÄ±zda kullanabilmek iÃ§in /etc/hosts dosyanÄ±za ÅŸu satÄ±rÄ± ekleyin:

```
127.0.0.1 myapp.local
```
![blue-green ingress](/img/Kubernetes_6.png)

Green sÃ¼rÃ¼mÃ¼ne trafiÄŸin yÃ¶nlendirilmesi amacÄ±yla aÅŸaÄŸÄ±daki komut kullanÄ±lÄ±r;

```bash
kubectl patch service myapp-live -n blue-green-demo \
  -p '{"spec": {"selector": {"app": "myapp", "version": "green"}}}'
```
![blue-green green](/img/Kubernetes_7.png)

Bu komutla ``myapp-live`` servisi artÄ±k ``green`` deployment'a yÃ¶nlendirilmiÅŸ olur. KullanÄ±cÄ±lar herhangi bir kesinti yaÅŸamadan yeni versiyonu kullanmaya baÅŸlar.

Eski sÃ¼rÃ¼me (blue) geri dÃ¶ndÃ¼rÃ¼lmesi amacÄ±yla aÅŸaÄŸÄ±daki komut kullanÄ±lÄ±r;

```bash
kubectl patch service myapp-live -n blue-green-demo \
  -p '{"spec": {"selector": {"app": "myapp", "version": "blue"}}}'
```
EÄŸer yeni versiyonda bir problem Ã§Ä±karsa, sadece bu komutla geri dÃ¶nÃ¼ÅŸ yapÄ±labilir. Blue versiyon Ã§alÄ±ÅŸmaya devam ederken green durdurulabilir veya debug edilebilir.

![blue-green blue](/img/Kubernetes_8.png)

SonuÃ§ olarak;

* Blue-Green Deployment ile uygulamanÄ± **kesintisiz bir ÅŸekilde gÃ¼ncellenebilir**.
* Rollback Ã§ok hÄ±zlÄ± ve gÃ¼venli bir ÅŸekilde gerÃ§ekleÅŸtirilebilir.
* Ingress Ã¼zerinden tek bir alan adÄ± (host) ile kullanÄ±cÄ±ya gÃ¶rÃ¼nmeyen versiyon geÃ§iÅŸi saÄŸlanabilir.
