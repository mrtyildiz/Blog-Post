# ğŸ“˜ AWS CloudWatch Nedir?

Amazon CloudWatch, AWS kaynaklarÄ±nÄ± ve uygulamalarÄ±mÄ±zÄ± izlemek iÃ§in kullanÄ±lan gÃ¼Ã§lÃ¼ bir **monitoring ve yÃ¶netim** servisidir. CloudWatch sayesinde sistemimizin **performansÄ±nÄ± takip edebilir**, **uyarÄ±lar oluÅŸturabilir**, **log kayÄ±tlarÄ±nÄ± toplayabilir** ve **otomasyon senaryolarÄ±** oluÅŸturabiliriz.
![ZGP](./img/AWS_CloudWatch.png)

## ğŸ¯ Ne Ä°ÅŸe Yarar?

CloudWatch; CPU kullanÄ±mÄ±, bellek durumu, disk okuma/yazma gibi sistem metriklerini toplar ve saklar. AyrÄ±ca uygulama loglarÄ±nÄ± da toplayarak hem canlÄ± izleme hem de geÃ§miÅŸe dÃ¶nÃ¼k analiz imkÃ¢nÄ± saÄŸlar.

## ğŸŒ Hangi Durumlarda KullanÄ±lÄ±r?

- **EC2 performans takibi**
- **Lambda fonksiyonlarÄ±nÄ±n hata oranlarÄ±**
- **Uygulama loglarÄ±nÄ±n analizi**
- **GerÃ§ek zamanlÄ± dashboard oluÅŸturma**
- **Servis durumu deÄŸiÅŸtiÄŸinde otomatik aksiyon alma (event-driven automation)**

---

## âš™ï¸ En SÄ±k KullanÄ±lan BileÅŸenler

| BileÅŸen              | AÃ§Ä±klama                                                |
|----------------------|----------------------------------------------------------|
| Metrics              | AWS servislerinden gelen performans verileri            |
| Logs                 | Uygulama ve sistem loglarÄ±nÄ±n merkezi olarak toplanmasÄ±  |
| Alarms               | Belirli eÅŸik deÄŸerleri aÅŸÄ±ldÄ±ÄŸÄ±nda tetiklenen uyarÄ±lar  |
| Dashboards           | GerÃ§ek zamanlÄ± gÃ¶rsel paneller                          |
| Events / EventBridge | Olay tabanlÄ± otomasyon tetikleyici                      |


## ğŸ›¡ï¸ Neden Ã–nemlidir?

CloudWatch, sistemde oluÅŸabilecek performans sorunlarÄ±nÄ± **Ã¶nceden tespit etmemizi** ve otomatik Ã¶nlemler almamÄ±zÄ± saÄŸlar. BÃ¶ylece kesintisiz hizmet sunma konusunda **proaktif bir yaklaÅŸÄ±m** geliÅŸtirmenize yardÄ±mcÄ± olur.

### AWS CloudWatch UygulamlarÄ±-1 - CloudWatch ile Uygulama LoglarÄ±nÄ±n Ä°zlenmesi ve Alarm Kurulumu

Bu senaryoda, AWS EC2 Ã¼zerinde oluÅŸan loglarÄ±n Amazon CloudWatch ile izlenmesi ve "ERROR" gibi kritik ifadeleri Metric Filter sayesinde tespit edilmesi ve bu durum otamatik olarak bir alarm olarak gÃ¶rÃ¼nmesini saÄŸlayacaÄŸÄ±z.

Senaroda Ã¶zet olarak yapÄ±lacak iÅŸlemler;

* EC2 instance oluÅŸturulmasÄ±.
* CloudWatch Agent kurulumu
* Uygulama loglarÄ±nÄ±n /var/log/myapp.log dosyasÄ±na yazÄ±lmasÄ±.
* "ERROR" iÃ§eren satÄ±rlar Metric Filter ile izlenmesi.
* Metrik eÅŸik deÄŸeri aÅŸarsa alarmÄ±n Ã¼retilmesi.

OrtamÄ±n kurulmasÄ± amacÄ±yla terraform kullanacaÄŸÄ±z;

**Dizin YapÄ±sÄ±**
```
Senaryo-1/
â”œâ”€â”€ main.tf
â”œâ”€â”€ variables.tf
â”œâ”€â”€ outputs.tf
â”œâ”€â”€ userdata.sh
â”œâ”€â”€ cloudwatch-agent-config.json
```

**main.tf**
```tf
provider "aws" {
  region                  = "us-east-1"
  shared_credentials_files = ["~/.aws/credentials"]
  profile                 = "vscode"
}
resource "aws_iam_role" "cw_agent_role" {
  name = "cw-agent-role"
  assume_role_policy = jsonencode({
    Version = "2012-10-17",
    Statement = [{
      Action    = "sts:AssumeRole",
      Effect    = "Allow",
      Principal = {
        Service = "ec2.amazonaws.com"
      }
    }]
  })
}

resource "aws_iam_role_policy_attachment" "cw_agent_attach" {
  role       = aws_iam_role.cw_agent_role.name
  policy_arn = "arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy"
}

resource "aws_instance" "log_ec2" {
  ami                    = "ami-0c2b8ca1dad447f8a" # Amazon Linux 2
  instance_type          = "t2.micro"
  key_name               = var.key_name
  iam_instance_profile   = aws_iam_instance_profile.ec2_profile.name
  user_data              = file("userdata.sh")
  associate_public_ip_address = true

  tags = {
    Name = "CloudWatchLogEC2"
  }
}

resource "aws_iam_instance_profile" "ec2_profile" {
  name = "cw-agent-profile"
  role = aws_iam_role.cw_agent_role.name
}

resource "aws_cloudwatch_log_group" "app_log_group" {
  name              = "/ec2/app-log"
  retention_in_days = 7
}

```
**variables.tf**
```tf
variable "key_name" {
  description = "EC2 iÃ§in kullanÄ±lacak SSH key pair adÄ±"
  type        = string
}

```
**outputs.tf**
```tf
output "instance_public_ip" {
  value = aws_instance.log_ec2.public_ip
}

```
**userdata.sh**
```bash
#!/bin/bash
yum update -y
yum install -y amazon-cloudwatch-agent

cat <<EOF > /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json
$(cat cloudwatch-agent-config.json)
EOF

/opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl \
  -a fetch-config -m ec2 -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json -s

# SimÃ¼lasyon iÃ§in sahte bir log oluÅŸtur
echo "INFO Service started" >> /var/log/myapp.log
echo "ERROR Something went wrong" >> /var/log/myapp.log

```
**cloudwatch-agent-config.json**
```tf
{
  "logs": {
    "logs_collected": {
      "files": {
        "collect_list": [
          {
            "file_path": "/var/log/myapp.log",
            "log_group_name": "/ec2/app-log",
            "log_stream_name": "{instance_id}",
            "timezone": "UTC"
          }
        ]
      }
    }
  }
}
```

OrtamÄ±n oluÅŸturulmasÄ± amacÄ±yla kullanÄ±lacak olan komutlar aÅŸaÄŸÄ±daki gibidir;

```
terraform init
terraform apply -var="key_name=<Anahtar_adÄ±>"
```
OluÅŸma iÅŸleminin ardÄ±ndna EC2 instance kontrol edilir. 

![cloudwatch](./img/68.png)

Metric Filter OluÅŸturulmasÄ± amacÄ±yla aÅŸaÄŸÄ±daki komut kullanÄ±lÄ±r.
```powershell
aws logs put-metric-filter `
  --log-group-name "/ec2/app-log" `
  --filter-name "ErrorFilter" `
  --filter-pattern '"ERROR"' `
  --metric-transformations `
    metricName="ErrorCount",metricNamespace="MyAppMetrics",metricValue="1" `
  --profile vscode
````
``/ec2/app-log`` adlÄ± log grubunda ``"ERROR"`` iÃ§eren log satÄ±rlarÄ±nÄ± sayar ve  Ã¶zel bir metrik metrik Ã¼retir.

Ãœretilen metriklerde ``ERROR`` deÄŸerini Ã¼rettiÄŸinde  belirtilen E-postaya mail gÃ¶nderilmesi iÃ§in aÅŸaÄŸÄ±daki komut kullanÄ±lÄ±r;

```powershell
$topicArn = aws sns create-topic --name AppErrorTopic --profile vscode | ConvertFrom-Json | Select-Object -ExpandProperty TopicArn

aws sns subscribe `
  --topic-arn $topicArn `
  --protocol email `
  --notification-endpoint "mail@email.com" `
  --profile vscode

```
Cloudwatch tarafÄ±nda bir uygun alarm oluÅŸturulmasÄ± amacÄ±yla aÅŸaÄŸÄ±daki komut kullanÄ±lÄ±r;

```powershell
aws cloudwatch put-metric-alarm `
  --alarm-name "ErrorAlarm" `
  --alarm-description "Triggers when ErrorCount >= 1" `
  --metric-name "ErrorCount" `
  --namespace "MyAppMetrics" `
  --statistic Sum `
  --period 60 `
  --threshold 1 `
  --comparison-operator GreaterThanOrEqualToThreshold `
  --evaluation-periods 1 `
  --alarm-actions $topicArn `
  --actions-enabled `
  --profile vscode
```

EK: AWS yÃ¶netmek iÃ§in kullandÄ±ÄŸÄ±m bilgiyarasÄ±m Windows'dur ve powershell terminalini kullanmaktayÄ±m.

![cloudwatch](./img/69.png)
Test iÅŸleminin gerÃ§ekleÅŸtirilmesi amacÄ±yla oluÅŸturmuÅŸ olduÄŸumuz EC2 instance baÄŸlanÄ±lÄ±r ve ```echo "ERROR Manual test $(date)" >> /var/log/myapp.log``` komutu kullanÄ±lÄ±r.
![cloudwatch](./img/70.png)

``myapp.log`` dosyasÄ±na yapÄ±lan bu deÄŸiÅŸim ardÄ±ndan AWS Cloud Ã¼zerinden ``Alarms`` `gÃ¶rÃ¼ntÃ¼lenir. GÃ¶rselde gÃ¶rÃ¼ldÃ¼ÄŸÃ¼ gibi yapÄ±lan test iÅŸleminden sonra ``In alarm`` gÃ¶rÃ¼lmektedir.

![cloudwatch](./img/71.png)

Daha detaylÄ± gÃ¶rÃ¼ntÃ¼lemek amacÄ±yla ``ÃˆrrorAlarm`` 'a tÄ±klanÄ±r. Hangi zaman dilimlerinde hata ile karÅŸÄ±laÅŸÄ±ldÄ±ÄŸÄ± gÃ¶rÃ¼lmektedir.

![cloudwatch](./img/72.png)

TanÄ±mlamÄ±ÅŸ olduÄŸumuz E-posta adresi konu Ã¶zelinde hazÄ±r mail gelmiÅŸtir.


![cloudwatch](./img/73.png)

OrtamÄ±n sÄ±fÄ±rlanmasÄ± amacÄ±yla aÅŸaÄŸÄ±daki komutlarÄ± sÄ±rasÄ±yla kullanabilirsiniz;

**Terraform ile OluÅŸturulan KaynaklarÄ±n Silinmesi iÃ§in**
``terraform destroy --var="key_name=Key_Monitor" --auto-approve``

**Metric Filter Silinmesi iÃ§in**
```
aws logs delete-metric-filter `
  --log-group-name "/ec2/app-log" `
  --filter-name "ErrorFilter" `
  --profile vscode
```

**CloudWatch Alarm Silmesi iÃ§in**

```
aws cloudwatch delete-alarms `
  --alarm-names "ErrorAlarm" `
  --profile vscode
```

**CloudWatch Alarm Silinmesi iÃ§in**

```
aws cloudwatch delete-alarms `
  --alarm-names "ErrorAlarm" `
  --profile vscode
```
**SNS Subscription ve Topic Silinmesi iÃ§in**

```
$topicArn = aws sns list-topics --profile vscode | ConvertFrom-Json | Select-Object -ExpandProperty Topics | Where-Object { $_.TopicArn -like "*AppErrorTopic" } | Select-Object -ExpandProperty TopicArn
```
**SNS Topic Silinmesi iÃ§in**
```
aws sns delete-topic `
  --topic-arn $topicArn `
  --profile vscode
```
![cloudwatch](./img/74.png)

### AWS CloudWatch UygulamlarÄ±-2 - AWS CloudWatch & EventBridge ile EC2 Otomatik Yeniden BaÅŸlatma (Auto-Remediation) Senaryosu

Bu senaryoda, Amazon EC2 instance'Ä±nÄ±n "stopped" durumuna geÃ§mesi durumunda otomatik olarak algÄ±lanÄ±r ve Amazon EventBridge Ã¼zerinden tetiklenen bir AWS Lambda fonksiyonu sayesinde EC2 yeniden baÅŸlatÄ±lÄ±r. Bu yapÄ±, sistemlerin self-healing (kendini iyileÅŸtirme) yeteneÄŸini artÄ±ran bir Ã¶zelliktir.

Ä°lk Ã¶ncelikle EC2 instance oluÅŸmasÄ± amacÄ±yla aÅŸaÄŸÄ±daki ``main.tf`` dosyasÄ± kullanÄ±lÄ±r;

```
provider "aws" {
  region                  = "us-east-1"
  shared_credentials_files = ["~/.aws/credentials"]
  profile                 = "vscode"
}

resource "aws_instance" "my_ec2" {
  ami                    = "ami-0c2b8ca1dad447f8a"
  instance_type          = "t2.micro"
  key_name               = "Key_Monitor"
  associate_public_ip_address = true

  tags = {
    Name = "AutoRecoveryEC2"
  }
}
```
Bu iÅŸlemin gerÃ§ekleÅŸtirilmesi amacÄ±yla kullanÄ±lacak olan komutlar aÅŸaÄŸÄ±daki gibidir;

```
terraform init
terraform apply
```
IAM RolÃ¼ (Identity and Access Management Role), AWS kaynaklarÄ± Ã¼zerinde belirli eylemleri gerÃ§ekleÅŸtirmek iÃ§in verilen geÃ§ici izinler kÃ¼mesidir. Bir kullanÄ±cÄ±ya, servise veya baÅŸka bir AWS hesabÄ±na belirli bir gÃ¶revi yerine getirirken bu rol atanabilir. IAM rolÃ¼nÃ¼ oluÅŸturmak iÃ§in ilk Ã¶ncelikle ``trust-policy.json`` dosyasÄ± oluÅŸturulur.

**trust-policy.json**
```
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "lambda.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
```

IAM rolÃ¼nÃ¼n oluÅŸturulmasÄ± iÃ§in aÅŸaÄŸÄ±daki sÄ±rasyÄ±la kullanÄ±lÄ±r;

```
aws iam create-role `
  --role-name LambdaEC2Role `
  --assume-role-policy-document file://trust-policy.json `
  --profile vscode
```

```
aws iam attach-role-policy `
  --role-name LambdaEC2Role `
  --policy-arn arn:aws:iam::aws:policy/AmazonEC2FullAccess `
  --profile vscode
```

```
aws iam attach-role-policy `
  --role-name LambdaEC2Role `
  --policy-arn arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole `
  --profile vscode
```

Lambda Ã¼zerinden Ã§alÄ±ÅŸacak olan fonksiyonun hazÄ±lanmasÄ± amacÄ±yla aÅŸaÄŸÄ±daki python scirpt oluÅŸturulur;

**restart_instance.py**
```
import boto3

def lambda_handler(event, context):
    ec2 = boto3.client('ec2')
    instance_id = event['detail']['instance-id']
    print(f"Restarting instance {instance_id}")
    ec2.start_instances(InstanceIds=[instance_id])
    return {"statusCode": 200, "body": f"Restarted {instance_id}"}

```
``restart_instance.py`` 'Ä±n ziplenmesi amacÄ±yla aÅŸaÄŸÄ±daki komut kullanÄ±lÄ±r;

```
Compress-Archive -Path .\restart_instance.py -DestinationPath .\function.zip -Force
```

Lambda fonksiyonunun oluÅŸturulmasÄ± amacÄ±yla aÅŸaÄŸÄ±daki komut kullanÄ±lÄ±r;

```
aws lambda create-function `
  --function-name RestartEC2Instance `
  --runtime python3.12 `
  --handler restart_instance.lambda_handler `
  --role arn:aws:iam::<ACCOUNT_ID>:role/LambdaEC2Role `
  --zip-file fileb://function.zip `
  --region us-east-1 `
  --profile vscode
```
Buradaki komut'ta bulunan ``<ACCOUNT_ID>`` kÄ±smÄ±nÄ± bulmak iÃ§in aÅŸaÄŸÄ±daki komut kullanÄ±lÄ±r;

```
aws sts get-caller-identity --query "Account" --output text --profile vscode
```

EventBridge KuralÄ±nÄ±n oluÅŸturulmasÄ± amacÄ±yla ilk Ã¶ncelikle ``event-pattern.json`` dosyasÄ± oluÅŸturulur.

**event-pattern.json**

```
{
  "source": ["aws.ec2"],
  "detail-type": ["EC2 Instance State-change Notification"],
  "detail": {
    "state": ["stopped"]
  }
}
```
KuralÄ±n oluÅŸturulmasÄ± amacÄ±yla aÅŸaÄŸÄ±daki komut kullanÄ±lÄ±r;

```
aws events put-rule `
  --name RestartStoppedEC2 `
  --event-pattern file://event-pattern.json `
  --region us-east-1 `
  --profile vscode
```

Lambda'ya yetki verilmesi amacÄ±yla ise;

```
aws lambda add-permission `
  --function-name RestartEC2Instance `
  --statement-id RestartOnStop `
  --action "lambda:InvokeFunction" `
  --principal events.amazonaws.com `
  --source-arn arn:aws:events:us-east-1:<ACCOUNT_ID>:rule/RestartStoppedEC2 `
  --region us-east-1 `
  --profile vscode  
```

EventBridge KuralÄ±nÄ±n Lambdaâ€™ya baÄŸlanmasÄ± amacÄ±yla aÅŸaÄŸÄ±daki komut kullanÄ±lÄ±r;

```
aws events put-targets `
  --rule RestartStoppedEC2 `
  --targets "Id=1,Arn=arn:aws:lambda:us-east-1:<ACCOUNT_ID>:function:RestartEC2Instance" `
  --region us-east-1 `
  --profile vscode
```

YapÄ±lan iÅŸlemlerin test edilmesi amacÄ±yla oluÅŸturulan EC2 instance durdurulmasÄ± amacÄ±yla aÅŸaÄŸÄ±daki komut kullanÄ±lÄ±r;

```
aws ec2 stop-instances `
  --instance-ids <EC2_ID> `
  --region us-east-1 `
  --profile vscode
```

![cloudwatch](./img/75.png)

Ä°ÅŸlemin kontrol edilmesi amacÄ±yla Amazon Console Ã¼zerinden EC2 instance kontrol edilir.

![cloudwatch](./img/76.png)

1-2 dakika beklendikten sonra yeniden kontrol edildiÄŸinde EC2 instance yeniden baÅŸlatÄ±ldÄ±ÄŸÄ± gÃ¶rÃ¼lecektir.

![cloudwatch](./img/77.png)

Hangi zaman dilimlerinde EC2 instance yeniden baÅŸlatÄ±ldÄ±ÄŸÄ±na veya kaÃ§ defa yeniden baÅŸlatÄ±ldÄ±ÄŸÄ± bilgisine `CloudWatch > Log groups > /aws/lambda/RestartEC2Instance` Ã¼zerinden ulaÅŸabilirsiniz.

![cloudwatch](./img/78.png)

Sistemi temizlenmesi ve oluÅŸturulan obje ve kurallarÄ±n silinmesi amacÄ±yla aÅŸaÄŸÄ±daki komutlarÄ± kullanabilirsiniz;

**Terraform kaynaklarÄ±nÄ±n silinmesi iÃ§in**

```terraform destroy```

**Lambda fonksiyonun silinmesi iÃ§in**

```
aws lambda delete-function `
  --function-name RestartEC2Instance `
  --region us-east-1 `
  --profile vscode
```

**EventBridge kuralÄ±nÄ±n silinmesi iÃ§in**

```
aws events remove-targets `
  --rule RestartStoppedEC2 `
  --ids 1 `
  --region us-east-1 `
  --profile vscode

aws events delete-rule `
  --name RestartStoppedEC2 `
  --region us-east-1 `
  --profile vscode
```

**IAM RolÃ¼nÃ¼ ve Policyâ€™lerini Silmesi iÃ§in**

```
aws iam detach-role-policy `
  --role-name LambdaEC2Role `
  --policy-arn arn:aws:iam::aws:policy/AmazonEC2FullAccess `
  --profile vscode

aws iam detach-role-policy `
  --role-name LambdaEC2Role `
  --policy-arn arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole `
  --profile vscode

aws iam delete-role `
  --role-name LambdaEC2Role `
  --profile vscode

```