# Docker Swarm 

**Docker Swarm**, birden fazla bilgisayarÄ± bir araya getirip tek bir sistem gibi uygulama Ã§alÄ±ÅŸtÄ±rmanÄ± saÄŸlayan gÃ¼Ã§lÃ¼ bir araÃ§tÄ±r.Docker Swarm, birden fazla Docker kurulu bilgisayarÄ± bir araya getirerek bu bilgisayarlarÄ± tek bir bÃ¼yÃ¼k sistem gibi kullanmanÄ± saÄŸlar. Bu duruma ÅŸÃ¶yle Ã¶rnek verilebilirim diyelim ki 3 bilgisyarÄ±nÄ±z var normal ÅŸartlarda hepsine ayrÄ± ayrÄ± kurulum yapmanÄ±z lazÄ±m. Ancak Docker swarm ile bu bilgisayarlarÄ± birleÅŸtirip hepsinde tek bir sistem varmÄ±ÅŸ gibi uygulama Ã§alÄ±ÅŸtÄ±rÄ±rsÄ±n. Neden Docker swarm kullanÄ±rÄ±z sorusunun cevabÄ± aÅŸaÄŸÄ±daki tablodaki gibidir;

| Problem                                | Docker Swarm ile Ã‡Ã¶zÃ¼m               |
| -------------------------------------- | ------------------------------------ |
| Tek sunucu yetmiyor                    | UygulamayÄ± birden fazla sunucuya yay |
| Sunucu Ã§Ã¶ktÃ¼ÄŸÃ¼nde elle mÃ¼dahale gerekiyor | Swarm otomatik yeniden baÅŸlatÄ±r      |
| GÃ¼ncelleme sÄ±rasÄ±nda sistem kapanÄ±yor  | Rolling update ile sÄ±fÄ±r kesinti     |
| Åifreleri dosyada tutmak aÅŸÄ±rÄ± gÃ¼vensiz      | Secret yÃ¶netimi ile koru             |

![Docker_Swarm](./img/docker-to-swarm-1.png)

Åimdide docker swarm 'Ä±n kurulumuna ve kullanÄ±mÄ±na bakalÄ±m. Benim ÅŸuan iki tane makinem var bunlarÄ±n bir linux diÄŸeri ise windows makinedir ve docker sistemler kurulu haldedir. Linux makinemi **Manager Node** (Ana Makine) olarak baÅŸlatacaÄŸÄ±m. Bu iÅŸlem iÃ§in ``docker swarm init --advertise-addr <IP_Adresi>`` komtu kullanÄ±lÄ±r.

![Docker_Swarm](./img/1.png)

Windows tarafÄ±nda bulunan ikinci docker makinemi **Worker Node** olarak kullanacaÄŸÄ±m. Bu iÅŸlem iÃ§in ``docker swarm join --token <Token> <IP_Adresi>:2377`` komutu kullanÄ±lÄ±r.
![Docker_Swarm](./img/2.png)

Docker swarm sistemimizi kurduk bu iÅŸlemin ardÄ±ndan ilk Ã¶rneÄŸimizi gerÃ§ekleÅŸtirelim. Docker swarm ile nginx server 'Ä±n oluÅŸturulmasÄ± amacÄ±yla aÅŸaÄŸÄ±daki komut kullanÄ±labilir(``Manager Node``).

```bash
docker service create \
  --name web \
  --replicas 3 \
  --publish 80:80 \
  nginx
```
Bu komut ile;

* ``--replicas 3``: 3 tane Nginx oluÅŸturulur.
* ``--publish 80:80``: 80 portu Ã¼zerinden konteyner Ã¼zerinde Ã§alÄ±ÅŸan nginx'e ulaÅŸÄ±labilir.
* ``--name web``: servisin adÄ±

![Docker_Swarm](./img/3.png)

Ä°ÅŸlem baÅŸarÄ±lÄ± bir ÅŸekilde gerÃ§ekleÅŸtirildikten sonra ``Manager Node`` ve ``Worker Node`` Ã§alÄ±ÅŸan konteynerlar aÅŸaÄŸÄ±daki gibidir;

``Manager Node``

![Docker_Swarm](./img/4.png)

``Worker Node``

![Docker_Swarm](./img/5.png)

OluÅŸturulmuÅŸ olan replika konteynerlar Ã§alÄ±ÅŸÄ±r durumdadÄ±r. OluÅŸturulmuÅŸ olan Docker swarm'larÄ±n listelenmesi amacÄ±yla ``docker service ls`` komutunu ``Manager Node`` Ã¼zerinde Ã§alÄ±ÅŸtÄ±rabilirsiniz.

Kesintisiz bir ÅŸekilde update iÅŸleminin gerÃ§ekleÅŸtirilmesi amacÄ±yla;

```bash
docker service update \
  --image nginx:1.25 \
  --update-parallelism 1 \
  --update-delay 10s \
  web
```
komutu kullanÄ±labilir. 
![Docker_Swarm](./img/7.png) 

GÃ¶rselde gÃ¶rÃ¼ldÃ¼ÄŸÃ¼ update iÅŸlemi gerÃ§ekleÅŸtirilmiÅŸtir. Bu update iÅŸlemi sÄ±rasÄ±nda herhangi bir kesinti ile karÅŸÄ±laÅŸÄ±lmamÄ±ÅŸtÄ±r. Bu durumun temel nedeni her update iÅŸlemi konteyner Ã¶zelinde sÄ±ralÄ± bir ÅŸekilde gerÃ§ekleÅŸmiÅŸtir. 


## Docker Swarm - Secret KullanÄ±mÄ±

Uygulama geliÅŸtirme aÅŸamasÄ±nda veritabanÄ± ÅŸifresi, API Key yada Ã¶zel bilgilerin kodun iÃ§erisine yazÄ±lmasÄ± uygulama gÃ¼venliÄŸi aÃ§Ä±sÄ±ndan oldukÃ§a riskli bir durumdur. Bu durumun Ã¶nÃ¼ne geÃ§ilmesi amacÄ±yla Docker Swarm 'da secret Ã¶zelliÄŸi kullanÄ±lÄ±r.
Docker Swarm 'Ä±n Ã§alÄ±ÅŸÄ±rken;

* Manager node tarafÄ±ndan encrypt ÅŸekilde saklanÄ±r.
* Sadece o serviste Ã§alÄ±ÅŸan containerâ€™lara, sadece Ã§alÄ±ÅŸma anÄ±nda eriÅŸim izni verilir.
* Dosya sistemi iÃ§inde /run/secrets/ dizininde okunur.

Secret kullanÄ±m adÄ±mlarÄ± aÅŸaÄŸÄ±daki gibidir;

1. Secret oluÅŸturma iÅŸlemi iÃ§in;
```bash
echo "TopSecret" | docker secret create db_password -
```
Komutu kullanÄ±labilir. Bu komutla db_password adÄ±nda bir secret oluÅŸturduk.
![Docker_Swarm](./img/8.png)

OluÅŸturulmuÅŸ olan bu secret 'Ä±n bir servis tarafÄ±ndan kullanÄ±lmasÄ± amacÄ±yla;

```bash
docker service create \
  --name backend-app \
  --secret db_password \
  nginx
```
![Docker_Swarm](./img/9.png)

sistem Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda secret'Ä±n Ã§alÄ±ÅŸan konteyner iÃ§erisinde ``/run/secrets/db_password`` dizinindedir.
![Docker_Swarm](./img/10.png)

GeliÅŸtirilmiÅŸ olan uygulamalar ihtiyaÃ§ duydukalarÄ± secret bilgilerini bu ÅŸekilde elde edebilirler. OluÅŸturulmuÅŸ olan secret 'Ä±n silinmesi amacÄ±yla aÅŸaÄŸÄ±daki komut kullanÄ±lmaktadÄ±r;

```bash
docker secret rm db_password
```
![Docker_Swarm](./img/11.png)

Docker-compose Ã¶zelinde secret 'Ä±n nasÄ±l kullanÄ±ldÄ±ÄŸÄ±na dair aÅŸaÄŸÄ±daki gibi bir Ã¶rnek verebilirim. 
```yml
version: "3.9"
services:
  backend:
    image: mybackend
    secrets:
      - db_password

secrets:
  db_password:
    external: true

```

Ã–rnekte gÃ¶rÃ¼lÃ¼ÄŸÃ¼ gibi secret sadece adlandÄ±rÄ±ldÄ±ÄŸÄ± halde docker-compose.yml dosyasÄ± iÃ§erisinde gÃ¶rÃ¼lmektedir. ``external: true`` ifadesi bu secret'Ä±n daha Ã¶nce tanÄ±mlanmÄ±ÅŸ oluÄŸunu gÃ¶stermektedir. Docker-compose Ã§alÄ±ÅŸttÄ±rÄ±lmasÄ± amacÄ±yla ``docker stack deploy -c docker-compose.yml mystack`` komutu kullanÄ±lÄ±r.

## Docker Swarm - AÄŸ OluÅŸturma (Overlay Network)

Docker Swarm'da birden fazla makinede Ã§alÄ±ÅŸan servisleri birbirleriyle Ã¶zel bir aÄŸ Ã¼zerinden gÃ¼venli iletiÅŸim kurmasÄ± iÃ§in ``Ã²verlay network`` kulllanÄ±lÄ±r. Overlay network, farklÄ± node'larda Ã§alÄ±ÅŸan konteynerlerÄ±n aynÄ± yerel aÄŸdaymÄ±ÅŸ gibi iletiÅŸim kurmasÄ±nÄ± saÄŸlar.

Overlay bir network'Ã¼n oluÅŸturulmasÄ± amaÃ§Ä±yla aÅŸaÄŸÄ±daki komut kullanÄ±lÄ±r;

```bash
docker network create \
  --driver overlay \
  --attachable \
  my_overlay
```
**Komutun AÃ§Ä±klamasÄ±**

* ``--driver overlay``: Overlay tipi aÄŸ oluÅŸturur.
* ``--attachable``: Bireysel containerâ€™larÄ±n bu aÄŸa katÄ±lmasÄ±na izin verir (Ã¶zellikle debug iÃ§in faydalÄ±).

OluÅŸturulmuÅŸ olan ``my_overlay`` adlÄ± network 'e servis tanÄ±mlanmasÄ± amacÄ±yla aÅŸaÄŸÄ±daki komutu kullanabilirsiniz;

```bash
docker service create \
  --name api \
  --network my_overlay \
  myapi:latest
```

``--network`` parametresiyle network tanÄ±mlanmÄ±ÅŸtÄ±r.

OluÅŸturulmuÅŸ olan network'Ã¼n docker-compose.yml Ã¶zelinde kullanÄ±labilmesi amacÄ±yla aÅŸaÄŸÄ±daki Ã¶rnekte gibi kullanabilirsiniz.

```yml
version: '3.9'
services:
  frontend:
    image: myfrontend
    networks:
      - app_net

  backend:
    image: mybackend
    networks:
      - app_net

networks:
  app_net:
    driver: overlay
```

docker-compose Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ± amacÄ±yla ``docker stack deploy -c docker-compose.yml mystack`` komut kullanÄ±labilir.

## Docker Swarm - Constraint KullanÄ±mÄ±

Docker Swarm'da bir uygulamanÄ±n hangi node'da Ã§alÄ±ÅŸtÄ±rÄ±lacaÄŸÄ±nÄ±n belirlenmesi amacÄ±yla etiketleme (labeling) ve yÃ¶nlendirme (constraint) kullanÄ±lÄ±r. Bu iÅŸlemin gerÃ§ekleÅŸtirilmesi amacÄ±yla aÅŸaÄŸÄ±daki iÅŸlem adÄ±mlarÄ± sÄ±rasÄ±yla uygulanÄ±r.
ilk olarak var olan nodelarÄ±n gÃ¶rÃ¼ntÃ¼lenmesi amacÄ±yla ``docker node ls`` komutu kullanÄ±lÄ±r.

![Docker_Swarm](./img/12.png)

Node adÄ± Ã¶ÄŸrenildikten sonra Ã¶rneÄŸin ``docker-desktop`` adlÄ± node iÃ§in aÅŸaÄŸÄ±daki komut ile etiket verilebilir.

```bash
docker node update --label-add type=windows-docker docker-desktop
```

![Docker_Swarm](./img/13.png)

Bu komutla docker-desktop artÄ±k type=windows-docker etiketini taÅŸÄ±r.

TanÄ±mlamÄ±ÅŸ olduÄŸumuz bu etiketi aÅŸaÄŸÄ±daki Ã¶rnek komutta olduÄŸu gibi kullanabiliriz.

```
docker service create \
  --name nginx-service \
  --constraint 'node.labels.type == windows-docker' \
  nginx:latest
```

![Docker_Swarm](./img/14.png)

GÃ¶rselde gÃ¶rÃ¼ldÃ¼ÄŸÃ¼ gibi baÅŸarÄ±lÄ± bir ÅŸekilde service oluÅŸturulmuÅŸtur. Manager Node Ã¼zerinden herhangi bir konteyner oluÅŸmamÄ±ÅŸtÄ±r. Ancak ``Worker Node`` bakÄ±ldÄ±ÄŸÄ±nda oluÅŸturulmuÅŸ olan konteynerÄ±n(servis'in) Ã§alÄ±ÅŸtÄ±ÄŸÄ± gÃ¶rÃ¼lmektedir.

![Docker_Swarm](./img/15.png)

OluÅŸturulmuÅŸ olan etiketin silinmesi amacÄ±yla aÅŸaÄŸÄ±daki iÅŸlem adÄ±mlarÄ± uygulanabilir;
Etiketin gÃ¶rÃ¼lmesi amacÄ±yla;
```bash
docker node inspect docker-desktop --format '{{ json .Spec.Labels }}'
```
Etiketin silinmesi amacÄ±yla;
```bash
docker node update --label-rm type docker-desktop
```
![Docker_Swarm](./img/16.png)

## Docker Swarm - Otomatik Yeniden BaÅŸlatma (Restart Policy)

Docker Swarm Ã¼zerinde Ã§alÄ±ÅŸan bir servis'in hata veya beklenmedik bir durum ile karÅŸÄ±laÅŸmasÄ± durumunda **restart policy** (otomatik yeniden baÅŸlatma politikasÄ±) devere girer. Bu Ã¶zellik sayesinde, servisler Ã§Ã¶kse bile otomatik olarak yeniden baÅŸlatÄ±lÄ±r ve sistem ayakta tutulur. BÃ¶ylece servis tarafÄ±ndan saÄŸlanan hizmet devam eder.

Bu Ã¶zellikler;

* Servis Ã§Ã¶ktÃ¼ÄŸÃ¼nde manuel mÃ¼dahale gerektirmemesi iÃ§in
* YÃ¼ksek eriÅŸilebilirlik (high availability) saÄŸlamak iÃ§in
* KullanÄ±cÄ±larÄ±n kesinti yaÅŸamamasÄ± iÃ§in
gereklidir.

Bu Ã¶zelliÄŸin temel anlamda kullanÄ±mÄ± aÅŸaÄŸÄ±daki gibidir;
Ä°lk Ã¶ncelikle Ã¶rnek bir servis oluÅŸturalÄ±m;

```
docker service create \
  --name hata-servisi \
  --restart-condition on-failure \
  --restart-delay 5s \
  --restart-max-attempts 3 \
  hata-test:v1
```
Komutu kullanÄ±labilir. 
![Docker_Swarm](./img/17.png)

Bu komutta kullanÄ±lan ``hata-test:v1`` image oluÅŸturulmasÄ± amacÄ±yla aÅŸaÄŸÄ±daki Dockerfile ve app.py kullanabilirsiniz;

**Dockerfile**

```dockerfile
# Dockerfile
FROM python:3.11-slim

WORKDIR /app

COPY app.py .

CMD ["python", "app.py"]
```

**app.py**
```python
# app.py
import time

print("âš ï¸  Uygulama baÅŸlatÄ±ldÄ±...")
time.sleep(3)
print("ğŸ’¥ HATA! SimÃ¼le edilmiÅŸ bir Ã§Ã¶kme")
exit(1)

```

Servisinde durumunun gÃ¶zlenmesi amacÄ±yla ``docker service ps hata-servisi`` komutu kullanÄ±lÄ±r. 
![Docker_Swarm](./img/18.png)

``task: non-zero exit (1)`` hatasÄ±nÄ±n Ã¼Ã§ defa verildiÄŸinde gÃ¶rev sonlandÄ±rÄ±lÄ±r.

Bu uygulamada ÅŸunu test etmiÅŸ olduk;

* ``exit(1)`` â†’ uygulama bilinÃ§li hata verdi,
* Docker Swarm â†’ hatayÄ± gÃ¶rdÃ¼ ve yeniden baÅŸlattÄ±,
* 5 saniye bekledi, 3 kez denedi â†’ sonunda durdu.

